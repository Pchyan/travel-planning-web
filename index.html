<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¦åŠƒåŠ©æ‰‹</title>
    <meta name="description" content="è¦åŠƒæ‚¨çš„å®Œç¾æ—…éŠè¡Œç¨‹ï¼Œæ”¯æŒé›¢ç·šç·¨è¼¯å’Œå¤šæ—¥è¡Œç¨‹å®‰æ’">
    <meta name="theme-color" content="#4a89dc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker è¨»å†ŠæˆåŠŸï¼Œç¯„åœï¼š', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker è¨»å†Šå¤±æ•—ï¼š', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ—…éŠè¦åŠƒåŠ©æ‰‹</h1>
            <div id="connection-status" class="connection-status online">
                <span class="status-icon">ğŸ”µ</span>
                <span class="status-text">å·²é€£æ¥</span>
            </div>
        </header>
        
        <main>
            <section class="input-section">
                <h2>è¡Œç¨‹è¦åŠƒ</h2>
                <div class="starting-point">
                    <label for="starting-point">å‡ºç™¼é»ï¼š</label>
                    <input type="text" id="starting-point" placeholder="è«‹è¼¸å…¥æ‚¨çš„å‡ºç™¼åœ°é»">
                    <button id="set-starting-point">è¨­å®š</button>
                </div>
                
                <div class="departure-time">
                    <label for="departure-date">å‡ºç™¼æ—¥æœŸï¼š</label>
                    <input type="date" id="departure-date">
                    <label for="departure-time">å‡ºç™¼æ™‚é–“ï¼š</label>
                    <input type="time" id="departure-time" value="09:00">
                    <button id="set-departure-time">è¨­å®š</button>
                </div>
                
                <div class="daily-hours">
                    <label for="max-daily-hours">æ¯æ—¥è¡Œç¨‹æ™‚é–“ï¼š</label>
                    <input type="number" id="max-daily-hours" min="1" max="24" step="0.5" value="8">
                    <span>å°æ™‚</span>
                    <button id="set-daily-hours">è¨­å®š</button>
                </div>
                
                <div class="save-load-buttons">
                    <button id="undo-button" title="å¾©åŸä¸Šä¸€æ­¥æ“ä½œ" disabled>â†©ï¸ å¾©åŸ</button>
                    <button id="redo-button" title="é‡åšå·²å¾©åŸçš„æ“ä½œ" disabled>â†ªï¸ é‡åš</button>
                    <button id="save-itinerary">å„²å­˜è¡Œç¨‹</button>
                    <button id="load-itinerary">è®€å–è¡Œç¨‹</button>
                    <button id="manage-itinerary">ç®¡ç†è¡Œç¨‹</button>
                    <button id="export-data">åŒ¯å‡ºè³‡æ–™</button>
                    <button id="import-data">åŒ¯å…¥è³‡æ–™</button>
                    <button id="repair-data" title="ä¿®å¾©æˆ–é‡ç½®æå£çš„æ•¸æ“š">ğŸ› ï¸ ä¿®å¾©æ•¸æ“š</button>
                </div>
                
                <div class="add-destination">
                    <label for="new-destination">æ–°å¢æ™¯é»ï¼š</label>
                    <input type="text" id="new-destination" placeholder="è«‹è¼¸å…¥æ™¯é»åç¨±">
                    <button id="add-destination">æ–°å¢</button>
                    <button id="set-coordinates-mode">ä½¿ç”¨ç¶“ç·¯åº¦</button>
                </div>
                
                <div id="coordinates-input-container" style="display: none;" class="coordinates-input">
                    <div class="coordinates-help">
                        <p>å¦‚ä½•å¾Googleåœ°åœ–ç²å–ç¶“ç·¯åº¦ï¼š</p>
                        <ol>
                            <li>åœ¨Googleåœ°åœ–ä¸­æ‰¾åˆ°ç›®æ¨™ä½ç½®</li>
                            <li>åœ¨ä½ç½®ä¸Š<strong>å³éµé»æ“Š</strong>é¸æ“‡ã€Œé€™æ˜¯å“ªè£¡ï¼Ÿã€</li>
                            <li>åœ°åœ–åº•éƒ¨æœƒé¡¯ç¤ºç¶“ç·¯åº¦ï¼Œä¾‹å¦‚ <code>25.0329694, 121.5654177</code></li>
                            <li>å°‡ç¬¬ä¸€å€‹æ•¸å­—å¡«å…¥ã€Œç·¯åº¦ã€ï¼Œç¬¬äºŒå€‹æ•¸å­—å¡«å…¥ã€Œç¶“åº¦ã€</li>
                        </ol>
                    </div>
                    <div class="coordinates-row">
                        <label for="latitude">ç·¯åº¦ï¼š</label>
                        <input type="text" id="latitude" placeholder="-90 åˆ° 90">
                    </div>
                    <div class="coordinates-row">
                        <label for="longitude">ç¶“åº¦ï¼š</label>
                        <input type="text" id="longitude" placeholder="-180 åˆ° 180">
                    </div>
                    <div class="coordinates-row">
                        <label for="coordinates-name">ä½ç½®åç¨±ï¼š</label>
                        <input type="text" id="coordinates-name" placeholder="è«‹è¼¸å…¥ä½ç½®åç¨±">
                    </div>
                    <button id="set-coordinates">è¨­å®šä½ç½®</button>
                    <button id="manage-coordinates">ç®¡ç†å·²å„²å­˜ä½ç½®</button>
                </div>
            </section>
            
            <section class="itinerary-section">
                <h2>è¡Œç¨‹å®‰æ’</h2>
                <div class="days-container">
                    <!-- è¡Œç¨‹å¤©æ•¸å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </section>
            
            <section class="map-section">
                <h2>åœ°åœ–é è¦½</h2>
                <div id="map"></div>
            </section>
        </main>
        
        <footer>
            <p>æ—…éŠè¦åŠƒåŠ©æ‰‹ &copy; 2023 | <a href="#" id="offline-status">é›¢ç·šç‹€æ…‹</a> | <a href="#" id="sync-now">ç«‹å³åŒæ­¥</a></p>
        </footer>
        
        <div id="offline-dialog" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>é›¢ç·šç‹€æ…‹</h3>
                <div id="offline-details">è¼‰å…¥ä¸­...</div>
                <button id="close-offline-dialog">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="transportationSystems.js"></script>
    <script src="app.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function updateOnlineStatus() {
                const statusElement = document.getElementById('connection-status');
                const isOnline = navigator.onLine;
                
                statusElement.className = isOnline ? 
                    'connection-status online' : 
                    'connection-status offline';
                
                statusElement.innerHTML = isOnline ? 
                    '<span class="status-icon">ğŸ”µ</span><span class="status-text">å·²é€£æ¥</span>' : 
                    '<span class="status-icon">ğŸ”´</span><span class="status-text">é›¢ç·šæ¨¡å¼</span>';
            }
            
            updateOnlineStatus();
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            document.getElementById('offline-status').addEventListener('click', function(e) {
                e.preventDefault();
                
                const dialog = document.getElementById('offline-dialog');
                const detailsElement = document.getElementById('offline-details');
                
                if (typeof syncQueue !== 'undefined') {
                    let html = `<p>ç¶²çµ¡ç‹€æ…‹ï¼š${navigator.onLine ? 'å·²é€£æ¥' : 'é›¢ç·š'}</p>`;
                    
                    if (syncQueue.length > 0) {
                        html += `<p>å¾…åŒæ­¥é …ç›®ï¼š${syncQueue.length}</p>`;
                        html += '<ul>';
                        
                        const displayItems = syncQueue.slice(0, 10);
                        displayItems.forEach(item => {
                            html += `<li>${item.type}: ${item.data ? item.data.name || 'æœªå‘½å' : 'ç„¡æ•¸æ“š'}</li>`;
                        });
                        
                        if (syncQueue.length > 10) {
                            html += `<li>...é‚„æœ‰ ${syncQueue.length - 10} å€‹é …ç›®</li>`;
                        }
                        
                        html += '</ul>';
                        
                        if (navigator.onLine) {
                            html += '<button id="sync-dialog-btn">ç«‹å³åŒæ­¥</button>';
                        }
                    } else {
                        html += '<p>æ²’æœ‰å¾…åŒæ­¥é …ç›®</p>';
                    }
                } else {
                    html = `<p>ç¶²çµ¡ç‹€æ…‹ï¼š${navigator.onLine ? 'å·²é€£æ¥' : 'é›¢ç·š'}</p>
                            <p>é›¢ç·šåŠŸèƒ½æœªåˆå§‹åŒ–æˆ–æœªæª¢æ¸¬åˆ°åŒæ­¥æ•¸æ“š</p>`;
                }
                
                detailsElement.innerHTML = html;
                dialog.style.display = 'block';
                
                const syncBtn = document.getElementById('sync-dialog-btn');
                if (syncBtn) {
                    syncBtn.addEventListener('click', function() {
                        if (typeof attemptSync === 'function') {
                            attemptSync();
                            dialog.style.display = 'none';
                        }
                    });
                }
            });
            
            document.getElementById('close-offline-dialog').addEventListener('click', function() {
                document.getElementById('offline-dialog').style.display = 'none';
            });
            
            document.getElementById('sync-now').addEventListener('click', function(e) {
                e.preventDefault();
                if (typeof attemptSync === 'function') {
                    attemptSync();
                } else {
                    alert('åŒæ­¥åŠŸèƒ½æœªåˆå§‹åŒ–');
                }
            });
        });
    </script>
</body>
</html>