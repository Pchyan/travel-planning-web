<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="旅遊規劃助手 - 輕鬆規劃您的旅遊行程，安排景點和交通方式">
    <meta name="theme-color" content="#4a89dc">
    <title>旅行規劃助手</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Font Awesome圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- 針對行動裝置的圖示 -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2161/2161423.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2161/2161423.png">
    <!-- 添加旅行記錄模組樣式 -->
    <link rel="stylesheet" href="travel-record.css" />
    <!-- 添加天氣服務模組樣式 -->
    <link rel="stylesheet" href="weather-styles.css" />
    <!-- 添加 AR 導航模組樣式 -->
    <link rel="stylesheet" href="ar-navigation.css" />
    <style>
        /* 添加 .hidden 類 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>旅行規劃助手</h1>
        </header>

        <!-- 交通延誤通知容器 -->
        <div id="transportation-alerts" class="transportation-alerts hidden">
            <div class="alert-header">
                <h3><i class="fas fa-exclamation-triangle"></i> 交通延誤通知</h3>
                <button id="close-transportation-alert" class="close-button"><i class="fas fa-times"></i></button>
            </div>
            <div class="alert-content">
                <div class="delay-info">
                    <p class="delay-message"></p>
                    <p class="delay-time"></p>
                </div>
                <div class="alternatives-container">
                    <h4>替代路線建議</h4>
                    <div class="alternatives-list"></div>
                </div>
            </div>
        </div>

        <main>
            <section class="input-section">
                <h2>行程規劃</h2>
                <div class="starting-point">
                    <label for="starting-point">出發點：</label>
                    <input type="text" id="starting-point" placeholder="請輸入您的出發地點">
                    <button id="set-starting-point"><i class="fas fa-map-marker-alt"></i> 設定</button>
                </div>

                <div class="departure-time">
                    <label for="departure-date">出發日期：</label>
                    <input type="date" id="departure-date">
                    <label for="departure-time">出發時間：</label>
                    <input type="time" id="departure-time" value="09:00">
                    <button id="set-departure-time"><i class="far fa-clock"></i> 設定</button>
                </div>

                <div class="daily-hours">
                    <label for="max-daily-hours">每日行程時間：</label>
                    <input type="number" id="max-daily-hours" min="1" max="24" step="0.5" value="8">
                    <span>小時</span>
                    <button id="set-daily-hours"><i class="fas fa-check"></i> 設定</button>
                </div>

                <div class="save-load-buttons">
                    <button id="new-itinerary"><i class="fas fa-file"></i> 規劃新行程</button>
                    <button id="undo-button" title="復原上一步操作" disabled><i class="fas fa-undo"></i> 復原</button>
                    <button id="redo-button" title="重做已復原的操作" disabled><i class="fas fa-redo"></i> 重做</button>
                    <button id="save-itinerary"><i class="fas fa-save"></i> 儲存行程</button>
                    <button id="load-itinerary"><i class="fas fa-folder-open"></i> 讀取行程</button>
                    <button id="manage-itinerary"><i class="fas fa-cog"></i> 管理行程</button>
                    <button id="export-data"><i class="fas fa-file-export"></i> 匯出資料</button>
                    <button id="import-data"><i class="fas fa-file-import"></i> 匯入資料</button>
                    <button id="repair-data" title="修復或重置損壞的數據"><i class="fas fa-tools"></i> 修復數據</button>
                    <!-- 在修復數據按鈕旁添加旅行記錄按鈕 -->
                    <button id="open-travel-record" title="查看和管理您的旅行記錄"><i class="fas fa-book"></i> 旅行記錄</button>
                </div>

                <div class="add-destination">
                    <label for="new-destination">新增景點：</label>
                    <input type="text" id="new-destination" placeholder="請輸入景點名稱">
                    <button id="add-destination"><i class="fas fa-plus"></i> 新增</button>
                    <button id="set-coordinates-mode"><i class="fas fa-map-pin"></i> 使用經緯度</button>
                </div>

                <div id="coordinates-input-container" style="display: none;" class="coordinates-input">
                    <div class="coordinates-help">
                        <p>如何從Google地圖獲取經緯度：</p>
                        <ol>
                            <li>在Google地圖中找到目標位置</li>
                            <li>在位置上<strong>右鍵點擊</strong>選擇「這是哪裡？」</li>
                            <li>地圖底部會顯示經緯度，例如 <code>25.0329694, 121.5654177</code></li>
                            <li>將第一個數字填入「緯度」，第二個數字填入「經度」</li>
                        </ol>
                    </div>
                    <div class="coordinates-row">
                        <label for="latitude">緯度：</label>
                        <input type="text" id="latitude" placeholder="-90 到 90" inputmode="decimal">
                    </div>
                    <div class="coordinates-row">
                        <label for="longitude">經度：</label>
                        <input type="text" id="longitude" placeholder="-180 到 180" inputmode="decimal">
                    </div>
                    <div class="coordinates-row">
                        <label for="coordinates-name">位置名稱：</label>
                        <input type="text" id="coordinates-name" placeholder="請輸入位置名稱">
                    </div>
                    <button id="set-coordinates"><i class="fas fa-check"></i> 設定位置</button>
                    <button id="manage-coordinates"><i class="fas fa-list"></i> 管理已儲存位置</button>
                </div>
            </section>

            <section class="itinerary-section">
                <h2>行程安排</h2>

                <div class="view-mode-toggle">
                    <label>顯示模式：</label>
                    <button id="page-mode-btn" class="view-mode-button"><i class="fas fa-book-open"></i> 翻頁模式</button>
                    <button id="list-mode-btn" class="view-mode-button active"><i class="fas fa-list"></i> 一頁式</button>
                </div>

                <div class="itinerary-summary">
                    <div class="summary-title">行程概覽</div>
                    <div class="summary-days" id="summary-days-container">
                        <!-- 這裡將由 JavaScript 動態填充日期選項 -->
                    </div>
                </div>

                <div id="itinerary-container">
                    <!-- 這裡將由 JavaScript 動態填充行程內容 -->
                </div>

                <div class="pager-controls">
                    <button id="prev-page-btn" class="page-nav-button"><i class="fas fa-chevron-left"></i> 上一天</button>
                    <div class="page-indicator">
                        <span>第 <span id="current-page">1</span> 天</span>
                        <div class="page-dots" id="page-dots-container">
                            <!-- 這裡將由 JavaScript 動態填充頁點 -->
                        </div>
                        <span>共 <span id="total-pages">0</span> 天</span>
                    </div>
                    <button id="next-page-btn" class="page-nav-button">下一天 <i class="fas fa-chevron-right"></i></button>
                </div>
            </section>

            <section class="map-section">
                <h2>地圖預覽</h2>
                <div class="map-controls">
                    <button id="start-ar-navigation" class="ar-nav-button" title="啟動 AR 導航">
                        <i class="fas fa-vr-cardboard"></i> AR 導航
                    </button>
                </div>
                <div id="map"></div>
            </section>
        </main>

        <footer>
            <p>旅遊規劃助手 &copy; <span id="current-year">2023</span></p>
            <p class="footer-note">使用 Font Awesome 圖示與 Leaflet 地圖技術</p>
            <div class="test-buttons">
                <button id="test-ar-button" class="test-button">測試 AR 導航</button>
                <button id="stop-test-ar-button" class="test-button">關閉測試 AR</button>
                <button id="test-transportation-delay" class="test-button">測試交通延誤</button>
            </div>
        </footer>
    </div>

    <!-- AR 導航容器 -->
    <div id="ar-container" class="ar-container">
        <!-- 相機視訊影像資源 -->
        <video id="ar-camera-feed" autoplay playsinline muted></video>
        <!-- A-Frame AR 場景 -->
        <a-scene id="ar-scene" class="ar-scene" embedded vr-mode-ui="enabled: false" renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true;">
            <!-- 相機設置 -->
            <a-entity camera look-controls wasd-controls="enabled: false" position="0 1.6 0"></a-entity>

            <!-- 目的地標記將在運行時動態添加 -->

            <!-- 方向指示器 -->
            <a-entity id="ar-direction-indicator" position="0 0 -5">
                <a-triangle color="#FF5722" rotation="0 0 0" scale="0.5 0.5 0.5"></a-triangle>
            </a-entity>

            <!-- 目的地標記模板 -->
            <a-entity id="destination-template" visible="false">
                <a-sphere radius="0.5" color="#4a89dc"></a-sphere>
                <a-text id="destination-text" value="目的地" position="0 1 0" align="center" color="white" scale="2 2 2"></a-text>
            </a-entity>

            <!-- 添加視訊影像平面 -->
            <a-entity id="ar-video-container" position="0 0 0">
                <a-plane id="ar-video-plane" position="0 0 -10" width="16" height="9" scale="2 2 2" material="shader: flat; src: #ar-camera-feed; transparent: true; opacity: 1"></a-plane>
            </a-entity>
        </a-scene>

        <!-- AR UI 元素 -->
        <button id="close-ar-navigation" class="ar-close-button">
            <i class="fas fa-times"></i>
        </button>

        <div class="ar-info-panel">
            <div class="ar-destination-info">
                <div class="ar-destination-name">目的地名稱</div>
                <div class="ar-destination-distance">距離: <span id="ar-distance">0</span> 公尺</div>
                <div class="ar-destination-time">預計時間: <span id="ar-time">0 分</span></div>
            </div>
        </div>

        <div class="ar-compass">
            <div class="ar-compass-arrow" id="ar-compass-arrow"></div>
        </div>

        <div class="ar-controls">
            <button class="ar-button" id="ar-center-view" title="將視圖對準目的地">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="ar-button" id="ar-next-destination" title="下一個目的地">
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Leaflet 地圖庫 -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- A-Frame VR/AR 框架 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <!-- AR.js 框架 -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>

    <!-- 專案腳本 -->
    <script src="transportationSystems.js"></script>
    <!-- 添加天氣服務模組腳本 -->
    <script src="weather-service.js"></script>
    <!-- 添加 AR 導航模組腳本 -->
    <script src="ar-navigation.js"></script>
    <!-- 添加交通服務模組腳本 -->
    <script src="transportation-service.js"></script>
    <!-- 添加交通延誤處理模組腳本 -->
    <script src="transportation-delay-handler.js"></script>
    <!-- 添加交通延誤初始化腳本 -->
    <script src="init-transportation-delay.js"></script>
    <script src="app.js"></script>
    <!-- 添加旅行記錄模組腳本 -->
    <script src="travel-record.js"></script>
    <script>
        // 自動更新頁腳年份
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // 測試 ARNavigation 對象是否正確加載
        console.log('ARNavigation 對象測試:', typeof ARNavigation);
        if (typeof ARNavigation !== 'undefined') {
            console.log('ARNavigation 方法測試:', {
                init: typeof ARNavigation.init,
                startARNavigation: typeof ARNavigation.startARNavigation,
                stopARNavigation: typeof ARNavigation.stopARNavigation,
                isSupported: typeof ARNavigation.isSupported
            });

            // 測試按鈕事件
            const testArButton = document.getElementById('test-ar-button');
            if (testArButton) {
                testArButton.addEventListener('click', function() {
                    console.log('測試 AR 導航按鈕被點擊');

                    // 創建測試數據
                    const testData = [
                        {
                            name: '測試出發點',
                            coordinates: {
                                latitude: 25.0330,
                                longitude: 121.5654
                            },
                            type: 'starting-point'
                        },
                        {
                            name: '測試目的地',
                            coordinates: {
                                latitude: 25.0340,
                                longitude: 121.5664
                            },
                            type: 'destination',
                            index: 1
                        }
                    ];

                    // 直接調用 AR 導航模組
                    try {
                        ARNavigation.startARNavigation(testData)
                            .then(success => {
                                if (success) {
                                    // 顯示 AR 容器
                                    document.getElementById('ar-container').classList.add('active');
                                    console.log('AR 導航測試已啟動');
                                }
                            })
                            .catch(error => {
                                console.error('AR 導航測試失敗:', error);
                                alert(`AR 導航測試失敗: ${error.message}`);
                            });
                    } catch (error) {
                        console.error('AR 導航測試失敗:', error);
                        alert(`AR 導航測試失敗: ${error.message}`);
                    }
                });
                console.log('測試按鈕事件已設置');
            } else {
                console.error('測試按鈕元素不存在');
            }

            // 關閉測試 AR 導航按鈕事件
            const stopTestArButton = document.getElementById('stop-test-ar-button');
            if (stopTestArButton) {
                stopTestArButton.addEventListener('click', function() {
                    console.log('關閉測試 AR 導航按鈕被點擊');

                    try {
                        // 調用 AR 導航模組的停止函數
                        ARNavigation.stopARNavigation();

                        // 隱藏 AR 容器
                        const arContainer = document.getElementById('ar-container');
                        if (arContainer) {
                            arContainer.classList.remove('active');
                            console.log('AR 導航測試已停止，容器已隱藏');
                        } else {
                            console.error('AR 容器元素不存在');
                        }
                    } catch (error) {
                        console.error('AR 導航測試停止失敗:', error);
                        alert(`AR 導航測試停止失敗: ${error.message}`);
                    }
                });
                console.log('關閉測試按鈕事件已設置');
            } else {
                console.error('關閉測試按鈕元素不存在');
            }
        }
    </script>
</body>
</html>